{% extends "base.html" %}
<!-- Import the macro at the top -->
{% from "_macros.html" import pagination_widget %}

{% block title %}Inventory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Inventory</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('export_inventory') }}" class="btn btn-sm btn-outline-success me-2">
            Export to CSV
        </a>
        <a href="{{ url_for('add_inventory') }}" class="btn btn-sm btn-outline-secondary">
            Add New Item
        </a>
    </div>
</div>

<div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Type to search for an item...">
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>#</th>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Low Stock At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="inventoryTableBody">
            <!-- UPDATED: We now loop over items.items from the pagination object -->
            {% for item in items.items %}
            <tr class="{{ 'table-danger' if item.quantity <= item.low_stock_threshold }}" data-name="{{ item.name|lower }}">
                <td>{{ item.id }}</td>
                <td>{{ item.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>${{ "%.2f"|format(item.price) }}</td>
                <td>{{ item.low_stock_threshold }}</td>
                <td>
                    <a href="{{ url_for('edit_inventory', item_id=item.id) }}" class="btn btn-warning btn-sm">Edit</a>
                    <a href="{{ url_for('delete_inventory', item_id=item.id) }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this item?');">Delete</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center">No inventory items found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- START: RENDER THE PAGINATION WIDGET -->
{% if items.pages > 1 %}
    {{ pagination_widget(items, 'inventory') }}
{% endif %}
<!-- END: RENDER THE PAGINATION WIDGET -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('inventoryTableBody');
        const rows = tableBody.getElementsByTagName('tr');

        searchInput.addEventListener('keyup', function() {
            const filter = searchInput.value.toLowerCase();
            for (let i = 0; i < rows.length; i++) {
                let row = rows[i];
                let itemName = row.getAttribute('data-name');
                if (itemName) {
                    if (itemName.includes(filter)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            }
        });
    });
</script>

{% endblock %}